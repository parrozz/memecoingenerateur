<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CoinFast‚Äëlike | Cr√©ateur de Memecoin (Solana)</title>
  <!-- Minimal styles (no build step needed) -->
  <style>
    :root{--bg:#0b0f14;--panel:#10161f;--muted:#7d8b9b;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--ink:#cbd5e1;--link:#60a5fa}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:20px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#0f172a,transparent)}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:32px;height:32px;border-radius:8px;background:#1f2937;display:grid;place-items:center;font-weight:700}
    h1{font-size:18px;margin:0}
    main{max-width:1100px;margin:0 auto;padding:24px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:980px){.grid{grid-template-columns:380px 1fr}}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .card h2{margin:0 0 8px;font-size:16px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px 12px;color:#e5e7eb;outline:none}
    input::placeholder{color:#475569}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:1px solid #303b4b;background:#0b1220;color:#e5e7eb;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#2563eb,#1d4ed8);border-color:#1d4ed8}
    .btn.ghost{background:transparent}
    .btn.warn{background:#3a2a00;border-color:#f59e0b;color:#ffd580}
    .btn.ok{background:#0b2a19;border-color:#16a34a;color:#b7f7c0}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .switch{display:inline-flex;gap:8px;align-items:center}
    .switch input{width:auto}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .log{background:#070b12;border:1px solid #111827;border-radius:12px;padding:10px;min-height:140px;max-height:260px;overflow:auto;white-space:pre-wrap}
    .pill{padding:3px 8px;border:1px solid #334155;border-radius:999px;font-size:12px}
    .hr{height:1px;background:#1f2937;margin:8px 0}
    a{color:var(--link);text-decoration:none}
    .foot{font-size:12px;color:#94a3b8}
  </style>
  <!-- ESM CDN imports: web3 + spl-token (no bundler needed) -->
  <script type="module">
    import {
      Connection, clusterApiUrl, PublicKey, SystemProgram, Transaction, Keypair, LAMPORTS_PER_SOL
    } from "https://esm.sh/@solana/web3.js@1.95.3";

    import {
      MINT_SIZE,
      getMinimumBalanceForRentExemptMint,
      createInitializeMintInstruction,
      getAssociatedTokenAddress,
      createAssociatedTokenAccountInstruction,
      createMintToInstruction,
      createSetAuthorityInstruction,
      AuthorityType
    } from "https://esm.sh/@solana/spl-token@0.4.7";

    // ---- Module-scope state (filled after DOM ready)
    let els = {};
    let wallet = null; // provider
    let connection = null;
    let lastMintPk = null;

    function log(msg, type='info'){
      if(!els.log) return;
      const t = new Date().toLocaleTimeString();
      const tag = type==='ok'?'‚úÖ':type==='warn'?'‚ö†Ô∏è':type==='err'?'üõë':'‚Ä¢';
      els.log.textContent += `[${t}] ${tag} ${msg}
`;
      els.log.scrollTop = els.log.scrollHeight;
    }

    function setConnection() {
      const network = els.net?.value || 'devnet';
      const rpc = els.rpc?.value?.trim?.() || clusterApiUrl(network);
      connection = new Connection(rpc, {commitment:'confirmed'});
      log(`RPC ‚Üí ${rpc}`);
    }

    async function refreshBalance(){
      try{
        if(!wallet?.publicKey || !connection) return;
        const lamports = await connection.getBalance(wallet.publicKey);
        els.balance.textContent = (lamports / LAMPORTS_PER_SOL).toFixed(4) + ' SOL';
      }catch(e){ log('Balance error: '+(e.message||e), 'warn'); }
    }

    // ---- Wallet detection helper
    function detectWallet(){
      const w = (window.solana && (window.solana.isPhantom || window.solana.isBackpack)) ? window.solana
              : (window.phantom?.solana ? window.phantom.solana : null);
      return w;
    }

    async function connect(){
      try{
        wallet = detectWallet();
        if(!wallet){
          log('Aucun wallet d√©tect√©. Installe Phantom et recharge la page.', 'warn');
          alert('Aucun wallet Solana d√©tect√©. Installe Phantom (phantom.app) et recharge la page.');
          return;
        }
        // trigger connect prompt from a user gesture
        if(!wallet.isConnected){
          await wallet.connect({ onlyIfTrusted:false });
        }
        els.addr.textContent = wallet.publicKey.toString();
        els.connectBtn.style.display='none';
        els.disconnectBtn.style.display='inline-flex';
        setConnection();
        await refreshBalance();
        log('Wallet connect√©.');
      }catch(e){
        log('Connexion wallet √©chou√©e: '+(e.message||e), 'err');
      }
    }

    async function disconnect(){
      try{ await wallet?.disconnect?.(); }catch{}
      wallet = null;
      els.addr.textContent = '-';
      els.balance.textContent = '-';
      els.connectBtn.style.display='inline-flex';
      els.disconnectBtn.style.display='none';
      log('Wallet d√©connect√©.');
    }

    const BN10 = (n)=> BigInt(n);
    function toBaseUnits(amountStr, decimals){
      const [intp, fracp=''] = String(amountStr).split('.');
      const safeFrac = (fracp + '0'.repeat(decimals)).slice(0, decimals);
      return BN10(intp) * BN10(10)**BN10(decimals) + BN10(safeFrac || 0);
    }

    async function simulateTx(tx){
      try{
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
        tx.feePayer = wallet.publicKey;
        const sim = await connection.simulateTransaction(tx, {sigVerify:false});
        if(sim.value.err){
          log('Simulation: ECHEC ‚Üí '+JSON.stringify(sim.value.err), 'warn');
        }else{
          log('Simulation: OK. unit√©s compute ‚âà '+sim.value.unitsConsumed, 'ok');
        }
      }catch(e){ log('Simulation error: '+(e.message||e), 'warn'); }
    }

    async function signAndSend(tx, extraSigners=[]) {
      tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
      tx.feePayer = wallet.publicKey;
      if(extraSigners.length) tx.partialSign(...extraSigners);
      if(typeof wallet.signAndSendTransaction === 'function'){
        const { signature } = await wallet.signAndSendTransaction(tx);
        log('Signature: '+signature);
        await connection.confirmTransaction(signature, 'confirmed');
        return signature;
      } else if(typeof wallet.signTransaction === 'function'){
        const signed = await wallet.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        log('Signature: '+sig);
        await connection.confirmTransaction(sig, 'confirmed');
        return sig;
      } else {
        throw new Error('Wallet ne supporte pas signTransaction.');
      }
    }

    async function createMintFlow(ev){
      ev?.preventDefault?.();
      if(!wallet?.publicKey) return alert('Connecte ton wallet.');
      setConnection();

      const decimals = parseInt(els.decimals.value || '6', 10);
      const supplyStr = els.supply.value.trim();
      const setFreeze = els.freeze.checked;

      if(!supplyStr) return alert('Renseigne un total supply.');
      if(decimals<0 || decimals>9) return alert('D√©cimales entre 0 et 9.');

      try{
        log('Pr√©paration de la cr√©ation du mint‚Ä¶');
        const mintKp = Keypair.generate();
        const mintPk = mintKp.publicKey;

        const rent = await getMinimumBalanceForRentExemptMint(connection);
        const createMintIx = SystemProgram.createAccount({
          fromPubkey: wallet.publicKey,
          newAccountPubkey: mintPk,
          space: MINT_SIZE,
          lamports: rent,
          programId: new PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA')
        });

        const initMintIx = createInitializeMintInstruction(
          mintPk,
          decimals,
          wallet.publicKey, // mint authority
          setFreeze ? wallet.publicKey : null // freeze authority
        );

        const ata = await getAssociatedTokenAddress(
          mintPk,
          wallet.publicKey,
        );
        const createAtaIx = createAssociatedTokenAccountInstruction(
          wallet.publicKey,
          ata,
          wallet.publicKey,
          mintPk
        );

        const amount = toBaseUnits(supplyStr, decimals);
        const mintToIx = createMintToInstruction(
          mintPk,
          ata,
          wallet.publicKey,
          amount
        );

        const tx1 = new Transaction().add(createMintIx, initMintIx, createAtaIx, mintToIx);
        await simulateTx(tx1);
        await signAndSend(tx1, [mintKp]);
        log('Mint cr√©√©: '+mintPk.toString(), 'ok');

        lastMintPk = mintPk;
        els.lastMint.textContent = mintPk.toString();
        els.dexScreenerLink.href = `https://dexscreener.com/solana/${mintPk.toString()}`;
        els.raydiumLink.href = `https://raydium.io/liquidity/`;

        const renounceList = [];
        if(els.renounceMint.checked){
          renounceList.push(createSetAuthorityInstruction(mintPk, wallet.publicKey, AuthorityType.MintTokens, null));
        }
        if(els.renounceFreeze.checked && setFreeze){
          renounceList.push(createSetAuthorityInstruction(mintPk, wallet.publicKey, AuthorityType.FreezeAccount, null));
        }
        if(renounceList.length){
          const tx2 = new Transaction().add(...renounceList);
          await simulateTx(tx2);
          await signAndSend(tx2);
          log('Autorit√©s renonc√©es selon options coch√©es.', 'ok');
        }

        await refreshBalance();
        log('Termin√©. Tu peux maintenant cr√©er une pool sur Raydium en utilisant ce mint.');
      }catch(e){
        console.error(e);
        log('Echec: '+(e.message||e), 'err');
      }
    }

    function wireEvents(){
      els.connectBtn?.addEventListener('click', connect);
      els.disconnectBtn?.addEventListener('click', disconnect);
      els.net?.addEventListener('change', setConnection);
      els.rpc?.addEventListener('change', setConnection);
      els.form?.addEventListener('submit', createMintFlow);
      els.createBtn?.addEventListener('click', createMintFlow);
      els.simulate?.addEventListener('click', async ()=>{
        if(!wallet?.publicKey) return alert('Connecte ton wallet.');
        setConnection();
        const mintKp = Keypair.generate();
        const rent = await getMinimumBalanceForRentExemptMint(connection);
        const tx = new Transaction().add(SystemProgram.createAccount({
          fromPubkey: wallet.publicKey,
          newAccountPubkey: mintKp.publicKey,
          space: MINT_SIZE, lamports: rent,
          programId: new PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA')
        }));
        await simulateTx(tx);
        log('Ceci n\'envoie rien, c\'est juste pour estimer la rent-exempt + frais.');
      });

      // expose safe fallbacks for inline onclick
      window.__cfConnect = connect;
      window.__cfDisconnect = disconnect;

      // auto-set connection
      setConnection();

      // optional: wallet events
      if(window.solana){
        try{
          window.solana.on?.('accountChanged', ()=>{ if(wallet?.publicKey){ els.addr.textContent = wallet.publicKey.toString(); refreshBalance(); } });
          window.solana.on?.('disconnect', ()=>{ disconnect(); });
        }catch{}
      }
    }

    function grabEls(){
      els = {
        connectBtn: document.getElementById('connect'),
        disconnectBtn: document.getElementById('disconnect'),
        addr: document.getElementById('addr'),
        balance: document.getElementById('balance'),
        rpc: document.getElementById('rpc'),
        net: document.getElementById('net'),
        form: document.getElementById('form'),
        log: document.getElementById('log'),
        lastMint: document.getElementById('lastMint'),
        raydiumLink: document.getElementById('raydiumLink'),
        dexScreenerLink: document.getElementById('dexScreenerLink'),
        simulate: document.getElementById('simulate'),
        createBtn: document.getElementById('createMintBtn'),
        renounceMint: document.getElementById('renounceMint'),
        renounceFreeze: document.getElementById('renounceFreeze'),
        decimals: document.getElementById('decimals'),
        supply: document.getElementById('supply'),
        freeze: document.getElementById('freeze')
      };
    }

    function init(){
      grabEls();
      // guard if HTML not parsed yet (shouldn't happen with module defer, but safe)
      if(!els.connectBtn){
        document.addEventListener('DOMContentLoaded', ()=>{ grabEls(); wireEvents(); });
      } else {
        wireEvents();
      }
      // toggle freeze row visibility
      const freezeEl = document.getElementById('freeze');
      const freezeRow = document.getElementById('freezeRow');
      freezeEl?.addEventListener('change', (e)=>{ if(freezeRow) freezeRow.style.display = e.target.checked? 'block':'none'; });
    }

    // ensure we run after DOM is parsed
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">CF</div>
      <div>
        <h1>Cr√©ateur de Memecoin (Solana) ‚Äì CoinFast‚Äëlike</h1>
        <div class="muted" style="font-size:12px">Tout‚Äëen‚Äëun, 100% dans le navigateur. Par d√©faut sur <span class="pill">devnet</span>.</div>
      </div>
    </div>
    <div class="flex">
      <button id="connect" class="btn" onclick="window.__cfConnect && window.__cfConnect()">Connecter le wallet</button>
      <button id="disconnect" class="btn ghost" style="display:none" onclick="window.__cfDisconnect && window.__cfDisconnect()">D√©connecter</button>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Param√®tres & R√©seau</h2>
      <div class="row">
        <div>
          <label>R√©seau</label>
          <select id="net">
            <option value="devnet" selected>Devnet (recommand√© pour tester)</option>
            <option value="mainnet-beta">Mainnet‚Äëbeta (r√©el)</option>
          </select>
        </div>
        <div>
          <label>RPC (optionnel)</label>
          <input id="rpc" placeholder="Laisse vide pour d√©faut du r√©seau" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Adresse</label>
          <div class="mono pill" id="addr">-</div>
        </div>
        <div>
          <label>Solde</label>
          <div class="mono pill" id="balance">-</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="flex">
        <button class="btn" id="simulate">Estimer les frais (simulation)</button>
      </div>
      <p class="foot">Astuce¬†: utilise un RPC priv√© (Helius/QuickNode) pour plus de fiabilit√©.</p>
    </section>

    <section class="card">
      <h2>Cr√©ation du Token SPL</h2>
      <form id="form">
        <div class="row">
          <div>
            <label>Nom (facultatif)</label>
            <input id="name" placeholder="ex. I AM STEVE" />
          </div>
          <div>
            <label>Symbole (facultatif)</label>
            <input id="symbol" placeholder="ex. STEVE" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>D√©cimales</label>
            <input id="decimals" type="number" min="0" max="9" value="6" />
          </div>
          <div>
            <label>Total supply (nombre humain)</label>
            <input id="supply" placeholder="ex. 1_000_000" />
          </div>
        </div>
        <div style="margin-top:10px" class="flex">
          <label class="switch"><input type="checkbox" id="freeze" /> <span>Activer un <b>freeze authority</b> (optionnel)</span></label>
          <label class="switch" id="freezeRow" style="display:none"><input type="checkbox" id="renounceFreeze" /> <span>Renoncer au freeze apr√®s mint</span></label>
          <label class="switch"><input type="checkbox" id="renounceMint" /> <span>Renoncer au mint authority apr√®s mint</span></label>
        </div>
        <div class="hr"></div>
        <div class="flex">
          <button type="submit" class="btn primary" id="createMintBtn">Cr√©er le token + envoyer le supply</button>
        </div>
        <p class="foot">Remarques¬†: le <em>name/symbol</em> ne sont visibles dans les wallets que si tu ajoutes des m√©tadonn√©es (Metaplex). Cette page se concentre sur la cr√©ation du mint + ATA + mintTo en s√©curit√©.</p>
      </form>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h2>√âtapes suivantes (Raydium / DexScreener)</h2>
      <div class="row">
        <div>
          <label>Dernier mint cr√©√©</label>
          <div id="lastMint" class="mono pill">-</div>
        </div>
        <div class="flex" style="align-items:end;justify-content:flex-end">
          <a id="dexScreenerLink" href="#" target="_blank" class="btn">Voir sur DexScreener</a>
          <a id="raydiumLink" href="#" target="_blank" class="btn ok">Ouvrir Raydium (cr√©er une pool)</a>
        </div>
      </div>
      <ol class="muted" style="margin-top:8px">
        <li>1) V√©rifie que le mint est correct sur un explorateur, puis cr√©e une <b>permissionless pool</b> sur Raydium (Token/SOL).</li>
        <li>2) D√©pose ta liquidit√© initiale avec des montants coh√©rents (attention aux MEV/bots).</li>
        <li>3) Option¬†: renonce aux autorit√©s (fait ici) et verrouille ta liquidit√© via un locker tiers si n√©cessaire.</li>
      </ol>
      <p class="foot">Avertissement¬†: Les op√©rations on-chain comportent des risques. Teste toujours sur <b>devnet</b> avant mainnet et lis les confirmations dans ton wallet.</p>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h2>Journal</h2>
      <div id="log" class="log" aria-live="polite"></div>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h2>FAQ S√©curit√© (r√©sum√©)</h2>
      <ul>
        <li>Cette page signe <b>uniquement</b> des transactions construites c√¥t√© client¬†; aucune cl√© priv√©e n‚Äôest expos√©e.</li>
        <li>Le compte <b>mint</b> est g√©n√©r√© localement, partiellement sign√©, puis ton wallet signe comme payeur ‚Üí pas de perte de contr√¥le.</li>
        <li>Tu peux cocher ‚ÄúRenoncer‚Äù pour retirer les autorit√©s <em>apr√®s</em> la cr√©ation (envoi s√©par√© pour √©viter de bricker le mint).</li>
        <li>Ajout de liquidit√© Raydium¬†: utilise l‚ÄôUI officielle pour cr√©er une pool permissionless, ou int√®gre ensuite un SDK serveur si tu veux tout automatiser.</li>
      </ul>
    </section>

    <footer class="foot" style="grid-column:1 / -1; text-align:center; padding:12px 0 24px">
      Construit pour tourner localement (ouvrir le fichier dans ton navigateur). Une connexion Internet est requise pour l‚ÄôRPC Solana.
    </footer>
  </main>
</body>
</html>
